<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Total Recall — State Share Target TFR</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{
      --bg:#080a0d;
      --grid:#1a1d22;
      --panel:#0a0c0f;
      --text:#e4e4e7;
      --muted:#a1a1aa;
      --accent:#ff4444;
      --line:#27272a;
      --stroke:#a1a1aa;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;letter-spacing:.02em;}
    body::before{
      content:"";position:fixed;inset:0;z-index:-1;
      background:
        radial-gradient(circle at 1px 1px, var(--grid) 1px, transparent 1px) 0 0/28px 28px,
        linear-gradient(var(--bg), var(--bg));
    }
    .shell{ display:grid;grid-template-rows: 60px 1fr auto;gap:0;height:100%; }
    .header{ background:var(--panel);border-bottom:1px solid var(--line);padding:0 24px;display:flex;align-items:center;grid-column:1 / -1; }
    .main-content{ display:grid;grid-template-columns: 340px 1fr;gap:16px;padding:16px;height:100%; }
    .panel{ background:var(--panel);border:1px solid var(--line);padding:16px;border-radius:8px;box-shadow:0 0 0 1px rgba(255,255,255,0.02) inset; }
    .title{font-size:24px;letter-spacing:.12em;text-transform:uppercase;color:var(--text);font-weight:600}
    .brand{font-size:14px;font-weight:400;letter-spacing:.05em;color:var(--muted);margin-left:24px}
    .accent{color:var(--accent)}
    .controls{padding:0}
    .controls label{display:block;margin:16px 0 8px;color:var(--text);font-size:13px;font-weight:500;text-transform:uppercase;letter-spacing:.03em}
    .control-group{display:flex;gap:8px;align-items:center;margin-bottom:20px}
    .controls input[type="number"]{
      width:80px;background:#050709;border:1px solid var(--line);color:var(--text);padding:6px 8px;border-radius:6px;font-size:14px;
    }
    .controls input[type="range"]{
      flex:1;background:transparent;border:none;padding:0;
      accent-color:var(--muted);
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.4;margin-top:12px}
    #map{height:100%;width:100%;background: #050709;border:1px solid var(--line);border-radius:8px}
    .footer{opacity:.8;font-size:12px;color:var(--muted)}
    .leaflet-tooltip{
      background:#0a0e12;color:var(--text);border:1px solid var(--line);border-radius:6px;padding:8px 10px;
      box-shadow:0 10px 16px rgba(0,0,0,.45);
    }
    .leaflet-tooltip b{color:var(--text)}
    .legend-pill{display:inline-block;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#050709}
    .metric{font-size:14px;color:var(--muted)}
    .metric strong{color:var(--text)}
    
    /* Hide mobile controls on desktop */
    .mobile-controls { display: none; }
    
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .shell { grid-template-rows: 60px 1fr; }
      .main-content { 
        grid-template-columns: 1fr;
        padding: 0;
        gap: 0;
        position: relative;
      }
      .header { padding: 0 16px; }
      .title { font-size: 16px; }
      .brand { font-size: 11px; }
      
      /* Desktop controls panel - hide on mobile */
      .panel.desktop-controls { display: none; }
      
      /* Map panel - full screen on mobile */
      .panel.map-container { 
        border: none;
        border-radius: 0;
        padding: 0;
        height: 100vh;
      }
      #map { 
        height: 100%;
        border: none;
        border-radius: 0;
      }
      
      /* Mobile controls panel - show on mobile */
      .mobile-controls {
        display: block;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--panel);
        border-top: 1px solid var(--line);
        transform: translateY(calc(100% - 60px));
        transition: transform 0.3s ease-out;
        z-index: 1000;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
      }
      
      .mobile-controls.expanded {
        transform: translateY(0);
      }
      
      .mobile-controls-header {
        height: 60px;
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--line);
        cursor: pointer;
        user-select: none;
      }
      
      .mobile-controls-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      .mobile-controls-toggle {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        transition: transform 0.3s ease;
      }
      
      .mobile-controls.expanded .mobile-controls-toggle {
        transform: rotate(180deg);
      }
      
      .mobile-controls-content {
        padding: 20px;
        max-height: 50vh;
        overflow-y: auto;
      }
      
      .controls input[type="number"] { width: 70px; }
      .control-group { gap: 12px; margin-bottom: 24px; }
      .controls input[type="range"] { 
        min-height: 44px;
        -webkit-appearance: none;
        appearance: none;
      }
      
      .controls input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: var(--muted);
        cursor: pointer;
      }
      
      .hint { margin-top: 16px; }
      
      /* Footer adjustments */
      .footer { 
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 999;
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
        border-radius: 0;
      }
      
      .footer.show { transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="title">TOTAL <span class="accent">RECALL</span></div>
      <div class="brand">Hover a state → see required TFR</div>
    </div>
    
    <div class="main-content">
      <div class="panel desktop-controls">
        <div class="controls">
        <label for="generations">Generations (T)</label>
        <div class="control-group">
          <input id="generations" type="range" min="1" max="20" step="1" value="10" oninput="gDisplay.value=this.value;updateAllTooltips()"/>
          <input id="gDisplay" type="number" min="1" max="50" step="1" value="10" oninput="generations.value=this.value;updateAllTooltips()"/>
        </div>

        <label for="share">Target Share p<sub>T</sub></label>
        <div class="control-group">
          <input id="share" type="range" min="0.01" max="0.90" step="0.01" value="0.25" oninput="sDisplay.value=this.value;updateAllTooltips()"/>
          <input id="sDisplay" type="number" min="0.01" max="0.99" step="0.01" value="0.25" oninput="share.value=this.value;updateAllTooltips()"/>
        </div>

        <div class="hint">
          Hover a state to see the <span class="accent">required TFR</span> for your lineage so that, starting from one woman out of the state's women, your descendants reach the chosen population share after T generations. Uses the closed‑form ratio solution with no migration; "others" use the state's current TFR.
        </div>
      </div>

      <div style="margin-top:14px">
        <span class="legend-pill metric">Baseline = state TFR<sub>2023</sub></span>
      </div>
      </div>

      <div class="panel map-container" style="display:flex;flex-direction:column;">
        <div id="map"></div>
      </div>
    </div>

    <!-- Mobile controls panel -->
    <div class="mobile-controls" id="mobileControls">
      <div class="mobile-controls-header" onclick="toggleMobileControls()">
        <div class="mobile-controls-title">Controls</div>
        <div class="mobile-controls-toggle">▲</div>
      </div>
      <div class="mobile-controls-content">
        <div class="controls">
          <label for="generations-mobile">Generations (T)</label>
          <div class="control-group">
            <input id="generations-mobile" type="range" min="1" max="20" step="1" value="10" oninput="gDisplayMobile.value=this.value;generations.value=this.value;gDisplay.value=this.value;updateAllTooltips()"/>
            <input id="gDisplayMobile" type="number" min="1" max="50" step="1" value="10" oninput="generationsMobile.value=this.value;generations.value=this.value;gDisplay.value=this.value;updateAllTooltips()"/>
          </div>

          <label for="share-mobile">Target Share p<sub>T</sub></label>
          <div class="control-group">
            <input id="share-mobile" type="range" min="0.01" max="0.90" step="0.01" value="0.25" oninput="sDisplayMobile.value=this.value;share.value=this.value;sDisplay.value=this.value;updateAllTooltips()"/>
            <input id="sDisplayMobile" type="number" min="0.01" max="0.99" step="0.01" value="0.25" oninput="shareMobile.value=this.value;share.value=this.value;sDisplay.value=this.value;updateAllTooltips()"/>
          </div>

          <div class="hint">
            Tap a state to see the <span class="accent">required TFR</span> for your lineage so that, starting from one woman out of the state's women, your descendants reach the chosen population share after T generations.
          </div>

          <div style="margin-top:20px">
            <span class="legend-pill metric">Baseline = state TFR<sub>2023</sub></span>
          </div>
        </div>
      </div>
    </div>

    <div class="panel footer" style="grid-column:1 / -1;">
      <div>Formula: TFR<sub>y</sub> = TFR<sub>o</sub> × (odds(p<sub>T</sub>)/odds(p<sub>0</sub>))<sup>1/T</sup>, with p<sub>0</sub> = 1 / women(state). Odds(p)=p/(1−p). Tooltips update live as you change the controls.</div>
    </div>
  </div>

  <script>
    // === Embedded data (from your CSVs) ===
    const WOMEN_BY_STATE = {
      "Alabama": 2557771,
      "Alaska": 353496,
      "Arizona": 3624212,
      "Arkansas": 1529296,
      "California": 19701268,
      "Colorado": 2823321,
      "Connecticut": 1866866,
      "Delaware": 504110,
      "Florida": 10854578,
      "Georgia": 5514282,
      "Hawaii": 724585,
      "Idaho": 932254,
      "Illinois": 6415523,
      "Indiana": 3362697,
      "Iowa": 1588648,
      "Kansas": 1469963,
      "Kentucky": 2271435,
      "Louisiana": 2365485,
      "Maine": 693650,
      "Maryland": 3053110,
      "Massachusetts": 3546593,
      "Michigan": 5048539,
      "Minnesota": 2877080,
      "Mississippi": 1508764,
      "Missouri": 3119073,
      "Montana": 540636,
      "Nebraska": 973805,
      "Nevada": 1385754,
      "New Hampshire": 708467,
      "New Jersey": 4633519,
      "New Mexico": 1057494,
      "New York": 10305635,
      "North Carolina": 5663649,
      "North Dakota": 380011,
      "Ohio": 5918953,
      "Oklahoma": 1984234,
      "Oregon": 2133703,
      "Pennsylvania": 6644628,
      "Rhode Island": 560531,
      "South Carolina": 2770698,
      "South Dakota": 429996,
      "Tennessee": 3372465,
      "Texas": 14539307,
      "Utah": 1161402,
      "Vermont": 318884,
      "Virginia": 4295179,
      "Washington": 3799679,
      "West Virginia": 894204,
      "Wisconsin": 2926498,
      "Wyoming": 283834
    };
    const TFR_BY_STATE = {
      "Alabama": 1.73,
      "Alaska": 1.83,
      "Arizona": 1.6,
      "Arkansas": 1.77,
      "California": 1.48,
      "Colorado": 1.37,
      "Connecticut": 1.33,
      "Delaware": 1.64,
      "Florida": 1.74,
      "Georgia": 1.7,
      "Hawaii": 1.65,
      "Idaho": 1.83,
      "Illinois": 1.58,
      "Indiana": 1.75,
      "Iowa": 1.83,
      "Kansas": 1.75,
      "Kentucky": 1.76,
      "Louisiana": 1.86,
      "Maine": 1.4,
      "Maryland": 1.61,
      "Massachusetts": 1.35,
      "Michigan": 1.61,
      "Minnesota": 1.72,
      "Mississippi": 1.89,
      "Missouri": 1.72,
      "Montana": 1.76,
      "Nebraska": 1.82,
      "Nevada": 1.45,
      "New Hampshire": 1.41,
      "New Jersey": 1.41,
      "New Mexico": 1.62,
      "New York": 1.43,
      "North Carolina": 1.69,
      "North Dakota": 1.83,
      "Ohio": 1.68,
      "Oklahoma": 1.83,
      "Oregon": 1.33,
      "Pennsylvania": 1.43,
      "Rhode Island": 1.45,
      "South Carolina": 1.67,
      "South Dakota": 1.93,
      "Tennessee": 1.75,
      "Texas": 1.64,
      "Utah": 1.92,
      "Vermont": 1.37,
      "Virginia": 1.62,
      "Washington": 1.42,
      "West Virginia": 1.6,
      "Wisconsin": 1.63,
      "Wyoming": 1.79
    };

    // === User controls references ===
    const genInput = document.getElementById('generations');
    const genDisplay = document.getElementById('gDisplay');
    const shareInput = document.getElementById('share');
    const shareDisplay = document.getElementById('sDisplay');
    
    // Mobile controls references
    const genInputMobile = document.getElementById('generations-mobile');
    const genDisplayMobile = document.getElementById('gDisplayMobile');
    const shareInputMobile = document.getElementById('share-mobile');
    const shareDisplayMobile = document.getElementById('sDisplayMobile');

    // sync helpers - updated to include mobile controls
    const generations = { 
      get value() { return +genInput.value; }, 
      set value(v) { 
        genInput.value=v; 
        genDisplay.value=v; 
        if (genInputMobile) genInputMobile.value=v;
        if (genDisplayMobile) genDisplayMobile.value=v;
      } 
    };
    const targetShare = { 
      get value() { return +shareInput.value; }, 
      set value(v) { 
        shareInput.value=v; 
        shareDisplay.value=v; 
        if (shareInputMobile) shareInputMobile.value=v;
        if (shareDisplayMobile) shareDisplayMobile.value=v;
      } 
    };

    // === Math helpers ===
    function odds(p) { return p/(1-p); }
    function safeClamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }

    // Required TFR_y for a state (closed-form, no migration)
    function requiredTFR(stateName) {
      const women = WOMEN_BY_STATE[stateName];
      const tfr_o = TFR_BY_STATE[stateName];
      if (!women || !tfr_o) return null;

      const T = safeClamp(generations.value, 1, 100);
      const pT = safeClamp(targetShare.value, 0.0001, 0.9999);

      const p0 = 1 / women; // per spec
      const m = Math.exp((Math.log(odds(pT)) - Math.log(odds(p0))) / T);
      return tfr_o * m;
    }

    // === Map ===
    // Use different zoom levels for mobile vs desktop
    const isMobile = window.innerWidth <= 768;
    const initialZoom = isMobile ? 3 : 4;
    const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([37.8, -96], initialZoom);
    // no base tile; we want a clean dark canvas

    const baseUrl = 'https://raw.githubusercontent.com/glynnbird/usstatesgeojson/master/';
    const stateFiles = [
      'alabama.geojson','alaska.geojson','arizona.geojson','arkansas.geojson',
      'california.geojson','colorado.geojson','connecticut.geojson','delaware.geojson',
      'florida.geojson','georgia.geojson','hawaii.geojson','idaho.geojson',
      'illinois.geojson','indiana.geojson','iowa.geojson','kansas.geojson',
      'kentucky.geojson','louisiana.geojson','maine.geojson','maryland.geojson',
      'massachusetts.geojson','michigan.geojson','minnesota.geojson','mississippi.geojson',
      'missouri.geojson','montana.geojson','nebraska.geojson','nevada.geojson',
      'new hampshire.geojson','new jersey.geojson','new mexico.geojson','new york.geojson',
      'north carolina.geojson','north dakota.geojson','ohio.geojson','oklahoma.geojson',
      'oregon.geojson','pennsylvania.geojson','rhode island.geojson','south carolina.geojson',
      'south dakota.geojson','tennessee.geojson','texas.geojson','utah.geojson',
      'vermont.geojson','virginia.geojson','washington.geojson','west virginia.geojson',
      'wisconsin.geojson','wyoming.geojson'
    ];

    // Track layers to retarget tooltips
    const layersByState = {};

    function formatTFR(x) {
      if (!isFinite(x)) return '—';
      if (x > 1000) return '>1000';
      return x.toFixed(2);
    }

    function tooltipHTML(stateName) {
      const t = requiredTFR(stateName);
      return `<b>${stateName}</b><br/>
              Required TFR<sub>y</sub>: <span class="accent">${formatTFR(t)}</span>`;
    }

    function transformCoordinates(coords, stateName) {
      if (stateName === 'Alaska') {
        // Scale and position Alaska in bottom left corner
        return coords.map(coord => {
          if (Array.isArray(coord[0])) {
            return coord.map(c => transformCoordinates([c], stateName)[0]);
          }
          const [lng, lat] = coord;
          
          // Alaska's approximate bounds: lng[-179, -129], lat[54, 71]
          const alaskaCenterLng = -154;
          const alaskaCenterLat = 62.5;
          
          // Scale factor
          const scale = 0.35;
          
          // Translate to center, scale, then position in bottom left
          const relativeToCenter_lng = lng - alaskaCenterLng;
          const relativeToCenter_lat = lat - alaskaCenterLat;
          
          const scaledLng = relativeToCenter_lng * scale;
          const scaledLat = relativeToCenter_lat * scale;
          
          // Position in bottom left (southwest of contiguous US)
          const newLng = -125 + scaledLng;
          const newLat = 25 + scaledLat;
          
          return [newLng, newLat];
        });
      }
      if (stateName === 'Hawaii') {
        // Scale and position Hawaii next to Alaska
        return coords.map(coord => {
          if (Array.isArray(coord[0])) {
            return coord.map(c => transformCoordinates([c], stateName)[0]);
          }
          const [lng, lat] = coord;
          
          // Hawaii's approximate bounds: lng[-178, -154], lat[18, 28]
          const hawaiiCenterLng = -157;
          const hawaiiCenterLat = 21;
          
          // Scale factor
          const scale = 0.8;
          
          // Translate to center, scale, then position next to Alaska
          const relativeToCenter_lng = lng - hawaiiCenterLng;
          const relativeToCenter_lat = lat - hawaiiCenterLat;
          
          const scaledLng = relativeToCenter_lng * scale;
          const scaledLat = relativeToCenter_lat * scale;
          
          // Position next to Alaska
          const newLng = -110 + scaledLng;
          const newLat = 20 + scaledLat;
          
          return [newLng, newLat];
        });
      }
      return coords;
    }

    function addStateLayer(geojson) {
      // Handle different GeoJSON structures
      let stateName;
      
      if (geojson && geojson.features && geojson.features[0] && geojson.features[0].properties) {
        stateName = geojson.features[0].properties.name;
      } else if (geojson && geojson.properties && geojson.properties.name) {
        // Single feature GeoJSON
        stateName = geojson.properties.name;
        geojson = { features: [geojson] }; // Wrap in features array
      } else {
        console.warn('Cannot determine state name from GeoJSON:', geojson);
        return;
      }
      
      // Capitalize state name properly (the files use lowercase)
      stateName = stateName.split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
      ).join(' ');
      
      // Transform Alaska and Hawaii coordinates
      if (stateName === 'Alaska' || stateName === 'Hawaii') {
        geojson.features.forEach(feature => {
          if (feature.geometry.type === 'Polygon') {
            feature.geometry.coordinates = feature.geometry.coordinates.map(ring => 
              transformCoordinates(ring, stateName)
            );
          } else if (feature.geometry.type === 'MultiPolygon') {
            feature.geometry.coordinates = feature.geometry.coordinates.map(polygon => 
              polygon.map(ring => transformCoordinates(ring, stateName))
            );
          }
        });
      }

      const layer = L.geoJSON(geojson, {
        style: { color: '#666', weight: 1.2, fillOpacity: 0.05, fillColor:'#777' },
        onEachFeature: (feature, lyr) => {
          const stateName = feature.properties.name;
          const content = tooltipHTML(stateName);
          lyr.bindTooltip(content, { permanent:false, direction:'top', sticky:true });

          lyr.on('mouseover', () => {
            lyr.setStyle({ weight: 2.2, fillOpacity: 0.15, color: '#aaa' });
            lyr.setTooltipContent(tooltipHTML(stateName));
            lyr.openTooltip();
          });
          lyr.on('mouseout', () => {
            lyr.setStyle({ weight: 1.2, fillOpacity: 0.05, color: '#666' });
            lyr.closeTooltip();
          });

          layersByState[stateName] = lyr;
        }
      }).addTo(map);
    }

    // Enable setTooltipContent on paths, if missing
    L.Path.prototype.setTooltipContent = function(html) {
      const tt = this.getTooltip();
      if (tt) tt.setContent(html); else this.bindTooltip(html);
    }

    // Load all states
    Promise.all(stateFiles.map(f => fetch(baseUrl + f).then(r => r.json())))
      .then(all => all.forEach(addStateLayer))
      .catch(err => console.error('Error loading state GeoJSON:', err));

    // Recompute tooltips when controls change
    function updateAllTooltips() {
      Object.keys(layersByState).forEach(stateName => {
        const lyr = layersByState[stateName];
        if (!lyr) return;
        lyr.setTooltipContent(tooltipHTML(stateName));
      });
    }
    window.updateAllTooltips = updateAllTooltips;
    
    // === Mobile Controls Functions ===
    function toggleMobileControls() {
      const mobileControls = document.getElementById('mobileControls');
      mobileControls.classList.toggle('expanded');
    }
    
    function hideMobileControls() {
      const mobileControls = document.getElementById('mobileControls');
      if (mobileControls.classList.contains('expanded')) {
        mobileControls.classList.remove('expanded');
      }
    }
    
    // Auto-hide mobile controls when map is interacted with
    function setupMobileAutoHide() {
      if (window.innerWidth <= 768) {
        // Hide controls on map interaction
        map.on('dragstart zoomstart', hideMobileControls);
        map.on('click', hideMobileControls);
        
        // Hide controls when tapping outside the controls panel
        document.addEventListener('touchstart', (e) => {
          const mobileControls = document.getElementById('mobileControls');
          if (!mobileControls.contains(e.target) && mobileControls.classList.contains('expanded')) {
            hideMobileControls();
          }
        });
      }
    }
    
    // Initialize mobile functionality after map loads
    setTimeout(setupMobileAutoHide, 1000);
    
    // Re-setup on resize
    window.addEventListener('resize', () => {
      setTimeout(setupMobileAutoHide, 100);
    });
  </script>
</body>
</html>
